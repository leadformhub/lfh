// LeadFormHub - Multi-tenant SaaS
// https://leadformhub.com

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserPlan {
  free
  pro
  business
}

enum UserStatus {
  active
  banned
}

// Form/lead field definitions live in JSON only. No DB column mapping.

model User {
  id                String    @id @default(cuid())
  name              String
  username          String    @unique
  email             String    @unique
  password          String
  authProvider      String?   @map("auth_provider") // 'google' | 'email'; null for legacy
  plan              UserPlan  @default(free)
  planValidUntil    DateTime? @map("plan_valid_until")
  status            UserStatus @default(active)
  emailVerifiedAt   DateTime? @map("email_verified_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  forms                Form[]
  leads                Lead[]
  pipelines            Pipeline[]
  subscriptions        Subscription[]
  passwordResets           PasswordReset[]
  accountDeletionRequests  AccountDeletionRequest[]
  verificationTokens       VerificationToken[]
  emailChangeRequests  EmailChangeRequest[]
  payments             Payment[]
  auditLogs            AuditLog[]
  supportRequests      SupportRequest[]
  feedback             Feedback[]
}

model EmailChangeRequest {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  newEmail  String   @map("new_email")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("email_change_requests")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  action    String   // e.g. lead_export
  metadata  String?  // JSON: { format?, formId?, count?, ... }
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model VerificationToken {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("verification_tokens")
}

model PasswordReset {
  id        String    @id @default(cuid())
  email     String
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  userId    String?   @map("user_id")
  user      User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AccountDeletionRequest {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("account_deletion_requests")
}

model Form {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  name       String
  schemaJson String    @db.Text @map("schema_json") // JSON: { fields: FormFieldSchema[], settings?: object }
  lockedAt   DateTime? @map("locked_at") // when set, form is locked (no edits, no public submissions)
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @default(now()) @updatedAt @map("updated_at")

  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  leads                  Lead[]
  pipelines              Pipeline[]
  otpVerifications       OtpVerification[]
  emailOtpVerifications  EmailOtpVerification[]
  smsLogs                SmsLog[]
  analyticsEvents        AnalyticsEvent[]
}

model EmailOtpVerification {
  id         String    @id @default(cuid())
  formId     String    @map("form_id")
  email      String
  otp        String
  expiresAt DateTime  @map("expires_at")
  verifiedAt DateTime? @map("verified_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  form Form @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId, email])
  @@map("email_otp_verifications")
}

model Lead {
  id         String   @id @default(cuid())
  formId     String?  @map("form_id") // null when form was deleted; leads are kept
  userId     String?  @map("user_id")  // null when user deleted; leads kept but unmapped
  stageId    String?  @map("stage_id") // optional; for Kanban board
  dataJson   String   @db.Text @map("data_json") // JSON of submitted field values (keyed by field id)
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  form       Form?          @relation(fields: [formId], references: [id], onDelete: SetNull)
  user       User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  stage      PipelineStage? @relation(fields: [stageId], references: [id], onDelete: SetNull)
  activities LeadActivity[]

  @@index([formId])
  @@index([userId])
  @@index([stageId])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([userId, formId])
  @@index([userId, formId, createdAt])
}

model LeadActivity {
  id        String   @id @default(cuid())
  leadId    String   @map("lead_id")
  type      String   // created | stage_changed | deleted
  metadata  String?  @db.Text // JSON: { stageId?, stageName?, fromStageId?, fromStageName?, ... }
  createdAt DateTime @default(now()) @map("created_at")

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([leadId, createdAt])
  @@map("lead_activities")
}

model Pipeline {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  formId    String?  @map("form_id") // optional; one pipeline per form or global
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user   User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  form   Form?           @relation(fields: [formId], references: [id], onDelete: Cascade)
  stages PipelineStage[]

  @@unique([userId, formId])
  @@index([userId])
  @@index([formId])
  @@map("pipelines")
}

model PipelineStage {
  id         String   @id @default(cuid())
  pipelineId String   @map("pipeline_id")
  name       String
  order      Int      // sort order
  createdAt  DateTime @default(now()) @map("created_at")

  pipeline Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  leads   Lead[]

  @@index([pipelineId])
  @@map("pipeline_stages")
}

model Plan {
  id          String   @id @default(cuid())
  name        String   @unique // free, pro, business
  maxForms    Int      @map("max_forms")
  otpLimit   Int?     @map("otp_limit") // null = no OTP
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  subscriptions Subscription[]
}

model Subscription {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  planId    String   @map("plan_id")
  otpUsedThisMonth Int @default(0) @map("otp_used_this_month")
  monthStart DateTime @map("month_start")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan @relation(fields: [planId], references: [id])
}

model OtpVerification {
  id        String    @id @default(cuid())
  formId    String    @map("form_id")
  phone     String
  otp       String
  expiresAt DateTime  @map("expires_at")
  verifiedAt DateTime? @map("verified_at")
  createdAt DateTime  @default(now()) @map("created_at")

  form Form @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId, phone])
  @@map("otp_verifications")
}

model SmsLog {
  id        String   @id @default(cuid())
  formId    String   @map("form_id")
  phone     String
  status    String   // sent, failed
  createdAt DateTime @default(now()) @map("created_at")

  form Form @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@map("sms_logs")
}

model AnalyticsEvent {
  id        String   @id @default(cuid())
  formId    String   @map("form_id")
  type      String   // view, submission
  metadata  String?  // JSON
  createdAt DateTime @default(now()) @map("created_at")

  form Form @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
  @@index([createdAt])
  @@index([formId, type])
  @@map("analytics_events")
}

model Payment {
  id               String    @id @default(cuid())
  userId           String    @map("user_id")
  razorpayOrderId  String    @unique @map("razorpay_order_id")
  razorpayPaymentId String?  @map("razorpay_payment_id")
  plan             String    // pro | business
  amount           Int       // paise
  currency         String    @default("INR")
  status           String    // created | captured | failed
  appliedAt        DateTime? @map("applied_at") // when we upgraded user from this payment (so we don't re-apply after manual downgrade)
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("payments")
}

model SupportRequest {
  id              String    @id @default(cuid())
  ticketNumber    String?   @unique @map("ticket_number") // e.g. LFH-000001 (optional for legacy rows)
  userId          String    @map("user_id")
  category        String    // billing | bug | feature | general | other
  subject         String
  message         String    @db.Text
  status          String    @default("open") // open | in_progress | resolved
  lastActivityAt  DateTime? @map("last_activity_at") // for auto-close after 7 days
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  user    User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  replies SupportRequestReply[]

  @@index([userId])
  @@index([status])
  @@index([ticketNumber])
  @@index([lastActivityAt])
  @@map("support_requests")
}

model SupportRequestReply {
  id              String   @id @default(cuid())
  supportRequestId String   @map("support_request_id")
  body            String   @db.Text
  isFromStaff     Boolean  @map("is_from_staff")
  createdAt       DateTime @default(now()) @map("created_at")

  supportRequest SupportRequest @relation(fields: [supportRequestId], references: [id], onDelete: Cascade)

  @@index([supportRequestId])
  @@map("support_request_replies")
}

model Feedback {
  id        String   @id @default(cuid())
  message   String   @db.Text
  userId    String?  @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdAt])
  @@map("feedback")
}
